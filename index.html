<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Korista Garage League</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="authBox" class="auth-box">
    <h2>Login</h2>
    <input id="username" placeholder="Username (for registration)">
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="register()">Register</button>
    <button onclick="login()">Login</button>
    <p class="auth-info">
        Leaderboard is public. Login to place bets.
    </p>
</div>

<div id="userBar" class="user-bar" style="display:none;">
    <span id="userInfo"></span>

    <button
        id="adminUpdateBtn"
        class="admin-btn"
        style="display:none; background:#ff4d4d;"
        onclick="calculateRace()"
    >
        ‚öôÔ∏è CALCULATE
    </button>

    <button onclick="logout()">Logout</button>
</div>

<div class="container">

    <h2 class="subtitle">KORISTA GARAGE HYPERCARS</h2>
    <h1>A LEAGUE TABLE</h1>

    <div class="season-info">
        SEASON 1 ‚Ä¢ 1 RACES PLAYED ‚Ä¢ CURRENT RACE: 8
    </div>

    <div class="table active">
        <div class="table-header">
            <span>POS</span>
            <span>CAR</span>
            <span>PTS</span>
        </div>

        <div class="row"><span>1</span><span>KOENIGSEGG JESKO ABSOLUT</span><span>25</span></div>
        <div class="row"><span>2</span><span>MERCEDES-MAYBACH EXELERO</span><span>18</span></div>
        <div class="row"><span>3</span><span>FERRARI P80/C</span><span>15</span></div>
        <div class="row"><span>4</span><span>PAGANI ZONDA HP BARCHETTA</span><span>12</span></div>
        <div class="row"><span>5</span><span>MERCEDES-BENZ 300 SLR</span><span>10</span></div>
        <div class="row"><span>6</span><span>PAGANI HUAYRA R</span><span>8</span></div>
        <div class="row"><span>7</span><span>FERRARI 812 SUPERFAST</span><span>6</span></div>
        <div class="row"><span>8</span><span>KOENIGSEGG CCXR TREVITA</span><span>4</span></div>
    </div>

    <button class="bet-btn" onclick="goToBet()">üé∞ PLACE BET</button>

    <a class="youtube-btn"
       href="https://www.youtube.com/@KORISTAGARAGE"
       target="_blank">
        ‚ñ∂ VISIT OUR YOUTUBE CHANNEL
    </a>

    <div class="footer">koristagarage.online</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script src="firebase.js"></script>
<script src="auth.js"></script>

<script>
async function calculateRace() {
    const raceId = prompt("Which race should we calculate? (e.g., race2)");
    if (!raceId) return;

    const raceRef = db.collection("races").doc(raceId);
    const betsRef = db
        .collection("bets")
        .doc(raceId)
        .collection("players");

    // RACE CHECK
    const raceSnap = await raceRef.get();
    if (!raceSnap.exists) {
        alert("Race not found");
        return;
    }

    const race = raceSnap.data();

    if (race.calculated === true) {
        alert("This race has already been calculated");
        return;
    }

    if (race.status !== "finished") {
        alert("Cannot calculate before the race is finished");
        return;
    }

    // GET BETS
    const betsSnap = await betsRef.get();

    if (betsSnap.empty) {
        alert("No bets placed for this race");
    }

    let winCount = 0;

    // üîÅ DISTRIBUTE POINTS
    for (const betDoc of betsSnap.docs) {
        const bet = betDoc.data();

        if (bet.paid === true) continue;

        if (bet.car === race.winner) {
            const userRef = db.collection("users").doc(betDoc.id);

            await userRef.update({
                points: firebase.firestore.FieldValue.increment(bet.stake * 2)
            });

            winCount++;
        }

        await betDoc.ref.update({
            paid: true
        });
    }

    // üîí CLOSE BETS
    await db.collection("bets").doc(raceId).update({
        status: "closed"
    });

    // ‚úÖ CLOSE RACE
    await raceRef.update({
        calculated: true
    });

    alert(
        raceId +
        " calculated ‚úÖ\n" +
        "Winner count: " + winCount + "\n" +
        "Week has been closed."
    );
}
</script>

</body>
</html>
