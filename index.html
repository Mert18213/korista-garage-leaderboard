<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Korista Garage League</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Modern Auth Styles */
        .auth-box {
            background: #0f172a;
            border: 2px solid #ffd700;
            border-radius: 15px;
            padding: 25px;
            max-width: 400px;
            margin: 40px auto;
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.15);
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 1px solid #334155;
        }

        .auth-tabs button {
            flex: 1;
            background: none;
            border: none;
            color: #94a3b8;
            padding: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .auth-tabs button.active {
            color: #ffd700;
            border-bottom: 3px solid #ffd700;
        }

        .auth-form input {
            width: 100%;
            padding: 14px;
            margin: 10px 0;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 10px;
            color: white;
            box-sizing: border-box;
            font-size: 14px;
        }

        .auth-form input:focus {
            outline: none;
            border-color: #ffd700;
            background: #0f172a;
        }

        .auth-form button#mainAuthBtn {
            width: 100%;
            padding: 16px;
            margin-top: 20px;
            background: #ffd700;
            border: none;
            border-radius: 10px;
            color: #000;
            font-weight: 800;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: transform 0.2s;
        }

        .auth-form button#mainAuthBtn:hover {
            background: #facc15;
            transform: translateY(-2px);
        }

        .auth-info {
            text-align: center;
            font-size: 13px;
            color: #94a3b8;
            margin-top: 15px;
        }
    </style>
</head>
<body>

<div id="authBox" class="auth-box">
    <div class="auth-tabs">
        <button id="tabLogin" class="active" onclick="toggleAuth('login')">Login</button>
        <button id="tabRegister" onclick="toggleAuth('register')">Register</button>
    </div>

    <div class="auth-form">
        <div id="usernameField" style="display:none;">
            <input id="regUsername" placeholder="Username">
        </div>
        
        <input id="email" type="email" placeholder="Email Address">
        <input id="password" type="password" placeholder="Password">
        
        <div id="confirmPasswordField" style="display:none;">
            <input id="confirmPassword" type="password" placeholder="Confirm Password">
        </div>

        <button id="mainAuthBtn" onclick="handleAuth()">Login</button>
    </div>
    
    <p class="auth-info">
        Leaderboard is public. Login to place bets.
    </p>
</div>

<div id="userBar" class="user-bar" style="display:none;">
    <span id="userInfo"></span>

    <button id="adminUpdateBtn" class="admin-btn" style="display:none; background:#ef4444;" onclick="calculateRace()">
        ‚öôÔ∏è CALCULATE
    </button>

    <button onclick="logout()">Logout</button>
</div>

<div class="container">
    <h2 class="subtitle">KORISTA GARAGE HYPERCARS</h2>
    <h1>A LEAGUE TABLE</h1>

    <div class="season-info">
        SEASON 1 ‚Ä¢ 2026 ‚Ä¢ CURRENT RACE ACTIVE
    </div>

    <div class="table active">
        <div class="table-header">
            <span>POS</span>
            <span>CAR</span>
            <span>PTS</span>
        </div>
        <div class="row"><span>1</span><span>KOENIGSEGG JESKO ABSOLUT</span><span>25</span></div>
        <div class="row"><span>2</span><span>MERCEDES-MAYBACH EXELERO</span><span>18</span></div>
        <div class="row"><span>3</span><span>FERRARI P80/C</span><span>15</span></div>
        <div class="row"><span>4</span><span>PAGANI ZONDA HP BARCHETTA</span><span>12</span></div>
        <div class="row"><span>5</span><span>MERCEDES-BENZ 300 SLR</span><span>10</span></div>
        <div class="row"><span>6</span><span>PAGANI HUAYRA R</span><span>8</span></div>
        <div class="row"><span>7</span><span>FERRARI 812 SUPERFAST</span><span>6</span></div>
        <div class="row"><span>8</span><span>KOENIGSEGG CCXR TREVITA</span><span>4</span></div>
    </div>

    <h2 style="margin-top:40px;">TOP 10 PLAYERS</h2>
    <div class="table active">
        <div class="table-header">
            <span>#</span>
            <span>USER</span>
            <span>PTS</span>
        </div>
        <div id="top10List"></div>
    </div>

    <button class="bet-btn" onclick="goToBet()">üé∞ GO TO BETTING PAGE</button>

    <div class="social-container">
        <a class="youtube-btn" href="https://www.youtube.com/@KORISTAGARAGE" target="_blank">‚ñ∂ YOUTUBE</a>
        <a class="instagram-btn" href="https://www.instagram.com/koristagarage" target="_blank">üì∏ INSTAGRAM</a>
        <a class="tiktok-btn" href="https://www.tiktok.com/@korista.garage" target="_blank">üéµ TIKTOK</a>
    </div>

    <div class="footer">koristagarage.online</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script src="firebase.js"></script>
<script src="auth.js"></script>

<script>
/* üîÑ AUTH TOGGLE LOGIC */
let currentMode = 'login';

function toggleAuth(mode) {
    currentMode = mode;
    const userField = document.getElementById('usernameField');
    const confirmField = document.getElementById('confirmPasswordField');
    const mainBtn = document.getElementById('mainAuthBtn');
    const tabLogin = document.getElementById('tabLogin');
    const tabRegister = document.getElementById('tabRegister');

    if (mode === 'register') {
        userField.style.display = 'block';
        confirmField.style.display = 'block';
        mainBtn.innerText = 'Create Account';
        tabRegister.classList.add('active');
        tabLogin.classList.remove('active');
    } else {
        userField.style.display = 'none';
        confirmField.style.display = 'none';
        mainBtn.innerText = 'Login';
        tabLogin.classList.add('active');
        tabRegister.classList.remove('active');
    }
}

async function handleAuth() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    if (currentMode === 'login') {
        if(!email || !password) return alert("Please fill all fields.");
        login(email, password); 
    } else {
        const username = document.getElementById('regUsername').value;
        const confirmPass = document.getElementById('confirmPassword').value;

        if (!username || !email || !password) {
            return alert("Please fill all fields.");
        }
        if (password !== confirmPass) {
            return alert("Passwords do not match!");
        }
        if (password.length < 6) {
            return alert("Password must be at least 6 characters.");
        }
        register(username, email, password);
    }
}

/* üèÜ TOP 10 PLAYERS */
async function loadTop10() {
    const list = document.getElementById("top10List");
    list.innerHTML = "Loading leaderboard...";
    try {
        const snap = await db.collection("users").orderBy("points", "desc").limit(10).get();
        list.innerHTML = "";
        let rank = 1;
        snap.forEach(doc => {
            const user = doc.data();
            list.innerHTML += `
                <div class="row">
                    <span>${rank}</span>
                    <span>${user.username}</span>
                    <span>${user.points}</span>
                </div>`;
            rank++;
        });
    } catch (e) { list.innerHTML = "Error loading players."; }
}
loadTop10();

/* ‚öôÔ∏è ADMIN CALCULATION */
async function calculateRace() {
    const raceId = prompt("Enter Race ID to calculate (e.g., race1):");
    if (!raceId) return;

    try {
        const raceRef = db.collection("races").doc(raceId);
        const raceSnap = await raceRef.get();
        if (!raceSnap.exists) return alert("Race not found.");

        const race = raceSnap.data();
        if (race.calculated) return alert("Already calculated.");
        if (race.status !== "finished") return alert("Race is not finished yet.");

        const betsSnap = await db.collection("bets").doc(raceId).collection("players").get();
        let winners = 0;

        for (const betDoc of betsSnap.docs) {
            const bet = betDoc.data();
            if (bet.car === race.winner) {
                await db.collection("users").doc(betDoc.id).update({
                    points: firebase.firestore.FieldValue.increment(bet.stake * 2)
                });
                winners++;
            }
            await betDoc.ref.update({ paid: true });
        }
        await raceRef.update({ calculated: true });
        alert(`Calculated! Winners: ${winners}`);
        loadTop10();
    } catch (e) { alert("Error: " + e.message); }
}

function goToBet() { window.location.href = "bet.html"; }
</script>

</body>
</html>
